<!-- -&#45;&#45;-->
<!--import SideBar from "../../layouts/SideBar.astro";-->
<!--import "../../styles/school.css";-->
<!-- -&#45;&#45;-->

<!--<SideBar/>-->

<!--<div class="container">-->
<!--    <h1 class="page-title">이번주 시간표</h1>-->
<!--    <h2 class="current-date"></h2>-->

<!--    <div class="card">-->
<!--        <div class="card-box select-box">-->
<!--            <label for="grade-select">학년:</label>-->
<!--            <select id="grade-select">-->
<!--                <option value="1">1 학년</option>-->
<!--                <option value="2">2 학년</option>-->
<!--                <option value="3">3 학년</option>-->
<!--            </select>-->

<!--            <label for="class-select">반:</label>-->
<!--            <select id="class-select">-->
<!--                <option value="1">1반</option>-->
<!--                <option value="2">2반</option>-->
<!--                <option value="3">3반</option>-->
<!--                <option value="4">4반</option>-->
<!--                <option value="5">5반</option>-->
<!--                <option value="6" >6반</option>-->
<!--                <option value="7">7반</option>-->
<!--                <option value="8">8반</option>-->
<!--                <option value="9">9반</option>-->
<!--                <option value="10">10반</option>-->
<!--            </select>-->
<!--        </div>-->
<!--    </div>-->

<!--    <section class="card">-->
<!--        <div class="card-box" id="timetable-box">시간표를 불러오는 중...</div>-->
<!--        <div class="buttons" id="timetable-buttons">-->
<!--            <button data-day="mon" class="active">월요일</button>-->
<!--            <button data-day="tue">화요일</button>-->
<!--            <button data-day="wed">수요일</button>-->
<!--            <button data-day="thu">목요일</button>-->
<!--            <button data-day="fri">금요일</button>-->
<!--        </div>-->
<!--    </section>-->
<!--</div>-->

<!--<script>-->
<!--    import { loadTimeTable } from "../../utils/timetableApp.ts";-->
<!--    import { formatDate } from "../../utils/dateUtils.ts";-->

<!--    const nowElement = document.querySelector<HTMLHeadingElement>(".current-date");-->
<!--    const today = new Date();-->

<!--    let todayDay: "mon" | "tue" | "wed" | "thu" | "fri";-->
<!--    if (today.getDay() === 6 || today.getDay() === 0) {-->
<!--        todayDay = "mon";-->
<!--    } else {-->
<!--        const dayMap: Record<number, "mon"|"tue"|"wed"|"thu"|"fri"> = { 1:"mon", 2:"tue", 3:"wed", 4:"thu", 5:"fri" };-->
<!--        todayDay = dayMap[today.getDay()] ?? "mon";-->
<!--    }-->

<!--    if (nowElement) nowElement.textContent = formatDate();-->

<!--    document.addEventListener("DOMContentLoaded", async () => {-->
<!--        const tableDiv = document.getElementById("timetable-box");-->
<!--        const buttons = document.querySelectorAll<HTMLButtonElement>("#timetable-buttons button");-->

<!--        const gradeSelect = document.getElementById("grade-select") as HTMLSelectElement;-->
<!--        const classSelect = document.getElementById("class-select") as HTMLSelectElement;-->

<!--        gradeSelect.value = "1";-->
<!--        classSelect.value = "6";-->

<!--        const messages = {-->
<!--            loading: "시간표를 불러오는 중...",-->
<!--            empty: "오늘은 수업이 없습니다."-->
<!--        };-->

<!--        function setState(state: "loading" | "empty" | "normal") {-->
<!--            if (!tableDiv) return;-->
<!--            if (state === "loading") {-->
<!--                tableDiv.textContent = messages.loading;-->
<!--            } else if (state === "empty") {-->
<!--                tableDiv.textContent = messages.empty;-->
<!--            }-->
<!--        }-->

<!--        function renderSection(title: string, content: string | string[]): string {-->
<!--            const items = Array.isArray(content)-->
<!--                ? content.map(c => `<div class="section-item">${c}</div>`).join("")-->
<!--                : `<div class="section-item">${content}</div>`;-->
<!--            return `<div><div class="section-title">${title}</div>${items}</div>`;-->
<!--        }-->

<!--        async function renderTable(day: "mon"|"tue"|"wed"|"thu"|"fri" = "mon") {-->
<!--            setState("loading");-->

<!--            const grade = gradeSelect.value;-->
<!--            const classNm = classSelect.value;-->

<!--            const data = await loadTimeTable(grade, classNm, day);-->

<!--            if (!data || !data.periods?.length) {-->
<!--                setState("empty");-->
<!--                return;-->
<!--            }-->

<!--            if (tableDiv) {-->
<!--                tableDiv.innerHTML = renderSection(`${formatDate(data.date)}`, data.periods);-->
<!--            }-->

<!--            setState("normal");-->
<!--        }-->

<!--        buttons.forEach(btn => {-->
<!--            btn.addEventListener("click", () => {-->
<!--                buttons.forEach(b => b.classList.remove("active"));-->
<!--                btn.classList.add("active");-->

<!--                const day = btn.dataset.day as "mon"|"tue"|"wed"|"thu"|"fri";-->
<!--                renderTable(day);-->
<!--            });-->
<!--        });-->

<!--        gradeSelect.addEventListener("change", () => renderTable(todayDay));-->
<!--        classSelect.addEventListener("change", () => renderTable(todayDay));-->

<!--        buttons.forEach(b => b.classList.remove("active"));-->
<!--        const todayBtn = document.querySelector(`#timetable-buttons button[data-day="${todayDay}"]`);-->
<!--        todayBtn?.classList.add("active");-->

<!--        await renderTable(todayDay);-->
<!--    });-->
<!--</script>-->
---
import "../../styles/school.css";
import SideBar from "../../layouts/SideBar.astro";
---
<SideBar/>

<div class="container">
    <h1 class="page-title">이번주 시간표</h1>
    <h2 class="current-date" id="currentDate"></h2>

    <div class="card">
        <div class="card-box select-box">
            <label for="grade">학년</label>
            <select id="grade">
                <option value="1">1 학년</option>
                <option value="2">2 학년</option>
                <option value="3">3 학년</option>
            </select>

            <label for="class">반</label>
            <select id="class">
                <!-- 기본 1~10 -->
                ${Array.from({length:10}, (_,i)=>`<option value="${i+1}">${i+1}반</option>`).join("")}
            </select>
        </div>
    </div>

    <section class="card">
        <div class="card-box" id="timetable-box">시간표를 불러오는 중...</div>
        <div class="buttons" id="timetable-buttons">
            <button data-day="mon" class="active">월요일</button>
            <button data-day="tue">화요일</button>
            <button data-day="wed">수요일</button>
            <button data-day="thu">목요일</button>
            <button data-day="fri">금요일</button>
        </div>
    </section>
</div>

<script type="module">
    import { loadTimeTable } from "../utils/timetableApp.js";
    import { formatDate, getKoreanDate } from "../utils/dateUtils.js";

    const currentDateEl = document.getElementById("currentDate");
    currentDateEl.textContent = formatDate();

    const box = document.getElementById("timetable-box");
    const gradeSel = document.getElementById("grade");
    const classSel = document.getElementById("class");
    const btns = Array.from(document.querySelectorAll("#timetable-buttons button"));

    // 오늘 요일에 따라 기본 버튼 선택
    const today = getKoreanDate();
    const dayMap = {1:"mon",2:"tue",3:"wed",4:"thu",5:"fri"};
    const todayKey = dayMap[today.getDay()] ?? "mon";

    btns.forEach(b => b.classList.remove("active"));
    const defaultBtn = document.querySelector(`#timetable-buttons button[data-day="${todayKey}"]`);
    defaultBtn?.classList.add("active");

    function setLoading() { box.textContent = "시간표를 불러오는 중..."; }
    function setEmpty() { box.textContent = "오늘은 수업이 없습니다."; }

    function renderSection(title, content){
        const items = Array.isArray(content) ? content.map(s=>`<div class="section-item">${s}</div>`).join("") : `<div class="section-item">${content}</div>`;
        return `<div><div class="section-title">${title}</div>${items}</div>`;
    }

    async function render(day="mon"){
        setLoading();
        const grade = gradeSel.value;
        const cls = classSel.value;
        const data = await loadTimeTable(grade, cls, day);
        if (!data || !data.periods.length) { setEmpty(); return; }
        box.innerHTML = renderSection(`${formatDate(data.date)}`, data.periods);
    }

    btns.forEach(b => b.addEventListener("click", async ()=>{
        btns.forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        await render(b.dataset.day);
    }));

    gradeSel.addEventListener("change", ()=>render(todayKey));
    classSel.addEventListener("change", ()=>render(todayKey));

    // 초기 렌더
    (async ()=>{ await render(todayKey); })();
</script>
