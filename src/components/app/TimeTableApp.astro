---
import SideBar from "../../layouts/SideBar.astro";
import "../../styles/school.css";
---

<SideBar/>

<div class="container">
    <h1 class="page-title">이번주 시간표</h1>
    <h2 class="current-date"></h2>

    <div class="card">
        <div class="card-box select-box">
            <label for="grade-select">학년:</label>
            <select id="grade-select">
                <option value="1">1 학년</option>
                <option value="2">2 학년</option>
                <option value="3">3 학년</option>
            </select>

            <label for="class-select">반:</label>
            <select id="class-select">
                <option value="1">1반</option>
                <option value="2">2반</option>
                <option value="3">3반</option>
                <option value="4">4반</option>
                <option value="5">5반</option>
                <option value="6" >6반</option>
                <option value="7">7반</option>
                <option value="8">8반</option>
                <option value="9">9반</option>
                <option value="10">10반</option>
            </select>
        </div>
    </div>

    <section class="card">
        <div class="card-box" id="timetable-box">시간표를 불러오는 중...</div>
        <div class="buttons" id="timetable-buttons">
            <button data-day="mon" class="active">월요일</button>
            <button data-day="tue">화요일</button>
            <button data-day="wed">수요일</button>
            <button data-day="thu">목요일</button>
            <button data-day="fri">금요일</button>
        </div>
    </section>
</div>

<script>
    import { loadTimeTable } from "../../utils/timetableApp.ts";
    import { formatDate } from "../../utils/dateUtils.ts";

    const nowElement = document.querySelector<HTMLHeadingElement>(".current-date");
    const today = new Date();
    const dayMap: Record<number, "mon"|"tue"|"wed"|"thu"|"fri"> = { 1:"mon", 2:"tue", 3:"wed", 4:"thu", 5:"fri" };
    const todayDay = dayMap[today.getDay()] ?? "mon";

    if (nowElement) nowElement.textContent = formatDate();

    document.addEventListener("DOMContentLoaded", async () => {
        const tableDiv = document.getElementById("timetable-box");
        const buttons = document.querySelectorAll<HTMLButtonElement>("#timetable-buttons button");

        const gradeSelect = document.getElementById("grade-select") as HTMLSelectElement;
        const classSelect = document.getElementById("class-select") as HTMLSelectElement;

        gradeSelect.value = "1";
        classSelect.value = "6";

        const messages = {
            loading: "시간표를 불러오는 중...",
            empty: "오늘은 수업이 없습니다."
        };

        function setState(state: "loading" | "empty" | "normal") {
            if (!tableDiv) return;
            if (state === "loading") {
                tableDiv.textContent = messages.loading;
            } else if (state === "empty") {
                tableDiv.textContent = messages.empty;
            }
        }

        function renderSection(title: string, content: string | string[]): string {
            const items = Array.isArray(content)
                ? content.map(c => `<div class="section-item">${c}</div>`).join("")
                : `<div class="section-item">${content}</div>`;
            return `<div><div class="section-title">${title}</div>${items}</div>`;
        }

        async function renderTable(day: "mon"|"tue"|"wed"|"thu"|"fri" = "mon") {
            setState("loading");

            const grade = gradeSelect.value;
            const classNm = classSelect.value;

            const data = await loadTimeTable(grade, classNm, day);

            if (!data || !data.periods?.length) {
                setState("empty");
                return;
            }

            if (tableDiv) {
                tableDiv.innerHTML = renderSection(`${formatDate(data.date)}`, data.periods);
            }

            setState("normal");
        }

        buttons.forEach(btn => {
            btn.addEventListener("click", () => {
                buttons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                const day = btn.dataset.day as "mon"|"tue"|"wed"|"thu"|"fri";
                renderTable(day);
            });
        });

        gradeSelect.addEventListener("change", () => renderTable(todayDay));
        classSelect.addEventListener("change", () => renderTable(todayDay));

        buttons.forEach(b => b.classList.remove("active"));
        const todayBtn = document.querySelector(`#timetable-buttons button[data-day="${todayDay}"]`);
        todayBtn?.classList.add("active");

        await renderTable(todayDay);
    });
</script>
