---
import "../../styles/lotto.css";
import SideBar from "../../layouts/SideBar.astro";
export const prerender = false;
---

<SideBar />

<div class="container">
    <h1 class="page-title">ğŸ° ë¡œë˜ ì¶”ì²¨</h1>

    <section class="card lotto-card">
        <div class="card-box lotto-box">

            <div id="draw-info" class="draw-info">
                ì¶”ì²¨ì€ <strong id="draw-time-text">--ì‹œ --ë¶„</strong>ì— ì§„í–‰ë©ë‹ˆë‹¤.
            </div>

            <div id="countdown" class="countdown">--:--:--</div>
            <div id="status" class="status-message"></div>

            <div id="entry-section" class="entry-section">
                {["ì„±ëª…", "ID"].map((label, idx) => (
                        <div class="lotto-item">
                            <label class="label">{label}</label>
                            <input
                                    id={idx === 0 ? "name" : "studentId"}
                                    class="input-box"
                                    placeholder={idx === 0 ? "ì˜ˆ) ì„œì§€ë¯¼" : "ì˜ˆ) 10614"}
                            />
                        </div>
                ))}

                <div class="lotto-item">
                    <span class="label">ë²ˆí˜¸ (1~10)</span>
                    <div class="number-inputs">
                        {Array.from({ length: 6 }).map((_, idx) => (
                                <input type="number" min="1" max="10" class="number-box" key={idx} />
                        ))}
                    </div>
                </div>

                <div class="buttons">
                    <button id="submit" class="button-common">ğŸŸï¸ ì°¸ì—¬í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </section>
    <div class="lotto-description" style="margin-top: 1rem; font-size: 0.9rem; color: #555; line-height: 1.4;">
        ë²ˆí˜¸ëŠ” 1~10 ì‚¬ì´ ìˆ«ì 6ê°œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ì°¸ì—¬ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
        ë‹¹ì²¨ìëŠ” ì¶”ì²¨ í›„ ë°œí‘œë˜ë©°, ì°¸ì—¬ ì¸ì›ìˆ˜ì— ë”°ë¼ ë‹¹ì²¨ í™•ë¥ ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ì„ ìƒë‹˜ë„ ì°¸ì—¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨ ID ì…ë ¥ë€ì—ëŠ” í•™ë²ˆì´ ì•„ë‹Œ ë‹¤ë¥¸ ë¬¸ìë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
    </div>

</div>

<script type="module">
    document.addEventListener("DOMContentLoaded", async () => {
        const entrySection = document.getElementById("entry-section");
        const statusBox = document.getElementById("status");
        const countdownBox = document.getElementById("countdown");
        const submitBtn = document.getElementById("submit");
        const drawTimeText = document.getElementById("draw-time-text");
        const drawInfo = document.getElementById("draw-info");

        const drawTime = new Date("2025-12-29T12:30:00");

        drawTimeText.textContent = `${drawTime.getHours()}ì‹œ ${drawTime.getMinutes()}ë¶„`;

        const WINNING_NUMBERS = [4, 7, 2, 8, 10, 7];

        let timer = null;

        function updateCountdown(diff) {
            if (diff <= 0) {
                if (timer) clearInterval(timer);
                showWinner();
                return;
            }
            const h = String(Math.floor(diff / 3600000)).padStart(2, "0");
            const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, "0");
            const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, "0");
            countdownBox.textContent = `${h}:${m}:${s}`;
        }

        async function showWinner() {
            entrySection.style.display = "none";
            drawTimeText.style.display = "none";
            drawInfo.style.display = "none";
            countdownBox.style.display = "none";

            // ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const res = await fetch("/api/lotto/list");
            const entries = res.ok ? await res.json() : [];

            // ë‹¹ì²¨ì ì°¾ê¸° (ì—¬ëŸ¬ëª… ê°€ëŠ¥)
            const winners = entries.filter(e => {
                const nums = e.numbers;
                return nums.slice().sort().join(",") === WINNING_NUMBERS.slice().sort().join(",");
            });

            const winnerNames = winners.length ? winners.map(w => w.name).join(", ") : "ì—†ìŒ";

            statusBox.innerHTML = `
            <h2>ğŸ‰ ì¶”ì²¨ ì™„ë£Œ</h2>
            <p style="font-size:1.5rem;">ë‹¹ì²¨ì : <strong>${winnerNames}</strong></p>
            <p style="font-size:1.5rem;">ë‹¹ì²¨ ë²ˆí˜¸ : <strong>${WINNING_NUMBERS.join(" ")}</strong></p>
            <p style="font-size:0.9rem; margin-top:0.5rem;">ì°¸ì—¬ì¸ì›ìˆ˜ : ${entries.length}ëª…</p>
        `;
        }

        function initCountdown() {
            const now = new Date();
            let diff = drawTime.getTime() - now.getTime();

            if (diff <= 0) {
                showWinner();
                return;
            }

            updateCountdown(diff);
            timer = setInterval(() => {
                diff = drawTime.getTime() - new Date().getTime();
                updateCountdown(diff);
            }, 1000);
        }

        initCountdown();

        // ì°¸ì—¬ ë²„íŠ¼
        submitBtn?.addEventListener("click", async () => {
            const name = document.getElementById("name").value.trim();
            const studentId = document.getElementById("studentId").value.trim();
            const numbers = Array.from(document.querySelectorAll(".number-box"), i => Number(i.value));

            if (!name || !studentId) return alert("ì´ë¦„ê³¼ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”");
            if (numbers.length !== 6 || numbers.some(n => n < 1 || n > 10 || !Number.isInteger(n)))
                return alert("ë²ˆí˜¸ëŠ” 1~10 ìˆ«ì 6ê°œì…ë‹ˆë‹¤");

            try {
                const res = await fetch("/api/lotto/entry", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, studentId, numbers }),
                });
                alert(await res.text());
            } catch (err) {
                console.error(err);
            }
        });
    });
</script>
