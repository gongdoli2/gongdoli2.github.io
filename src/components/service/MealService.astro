---
import SideBar from "../../layouts/SideBar.astro";
import "../../styles/school.css"
---

<SideBar/>

<div class="container">
    <h1 class="page-title">오늘의 급식</h1>
    <h2 class="current-date"></h2>

    <section class="card">
        <div class="card-box" id="meal-box">급식을 불러오는 중..</div>

        <div class="buttons">
            <button data-meal="1">조식</button>
            <button data-meal="2" class="active">중식</button>
            <button data-meal="3">석식</button>
        </div>
    </section>

    <section class="card">
        <div class="card-box" id="cal-box">칼로리를 불러오는 중...</div>
    </section>

    <section class="card">
        <div class="card-box" id="nut-box">영양정보를 불러오는 중...</div>
    </section>
</div>


<script>
    import { loadMeal } from "../../utils/mealApp.ts";
    import { formatDate } from "../../utils/dateUtils.ts";

    const mealDiv = document.getElementById("meal-box") as HTMLDivElement;
    const calDiv = document.getElementById("cal-box") as HTMLDivElement;
    const nutDiv = document.getElementById("nut-box") as HTMLDivElement;
    const mealButtons = document.querySelectorAll<HTMLButtonElement>(".buttons button");

    const messages = {
        loading: {
            meal: "급식을 불러오는 중...",
            cal: "칼로리를 불러오는 중...",
            nut: "영양정보를 불러오는 중..."
        },
        empty: {
            meal: "<div class='card-box'>오늘은 급식이 없습니다.</div>",
            cal: "",
            nut: ""
        }
    };

    function setState(state: "loading" | "empty") {
        mealDiv.innerHTML = messages[state].meal;
        calDiv.innerHTML = messages[state].cal;
        nutDiv.innerHTML = messages[state].nut;
    }

    function renderSection(title: string, content: string | string[]) {
        const items = Array.isArray(content)
            ? content.map(d => `<div class="section-item">${d}</div>`).join("")
            : `<div class="section-item">${content}</div>`;

        return `
        <div>
            <div class="section-title">${title}</div>
            ${items}
        </div>
    `;
    }

    async function renderMeal(mealType: string = "2") {
        setState("loading");

        const mealData = await loadMeal(mealType);

        if (!mealData || !mealData.dishes?.length) {
            setState("empty");
            return;
        }

        mealDiv.innerHTML = `<div class="card-box">${renderSection("급식", mealData.dishes)}</div>`;
        calDiv.innerHTML = `<div class="card-box">${renderSection("칼로리", mealData.cal)}</div>`;
        nutDiv.innerHTML = `<div class="card-box">${renderSection("영양정보", mealData.nutrition)}</div>`;
    }


    function updateNow() {
        const nowElement = document.querySelector(".current-date");
        if (nowElement) nowElement.textContent = formatDate();
    }

    mealButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            mealButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            renderMeal(btn.dataset.meal ?? "2");
            updateNow();
        });
    });

    window.addEventListener("DOMContentLoaded", () => {
        renderMeal("2");
        updateNow();
    });
</script>
